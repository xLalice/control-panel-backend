generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}


model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  users       User[]       @relation("RoleUsers")
  permissions Permission[] @relation("RolePermissions")
}

model Permission {
  id     Int    @id @default(autoincrement())
  name   String @unique
  module String
  roles  Role[] @relation("RolePermissions")
}

model User {
  id                 String           @id @default(cuid())
  email              String           @unique
  password           String
  roleId             Int              @default(1)
  name               String
  isOJT              Boolean          @default(false)
  ojtStartDate       DateTime?
  ojtEndDate         DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  activityLog        ActivityLog[]
  allowedIPs         AllowedIP[]
  attendanceRecords  Attendance[]
  contactHistory     ContactHistory[]
  documents          Document[]
  assignedInquiryies Inquiry[]        @relation("assignedInquiries")
  inquiries          Inquiry[]
  assignedLeads      Lead[]           @relation("assignedLeads")
  createdLeads       Lead[]           @relation("createdLeads")
  quotations         Quotation[]
  reports            Report[]
  role               Role             @relation("RoleUsers", fields: [roleId], references: [id])
}

model Report {
  id           String   @id @default(uuid())
  date         DateTime
  reportedById String
  location     String   @default("Remote")
  taskDetails  String
  createdAt    DateTime @default(now())
  reportedBy   User     @relation(fields: [reportedById], references: [id])
}

model Company {
  id        String   @id @default(uuid())
  name      String   @unique
  industry  String?
  region    String?
  email     String?
  phone     String?
  website   String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clients   Client[]
  leads     Lead[]

  @@index([name])
  @@index([email])
  @@index([phone])
  @@index([isActive])
}

model Lead {
  id                   String           @id @default(uuid())
  companyId            String?
  contactPerson        String?
  email                String
  phone                String?
  status               LeadStatus       @default(New)
  source               String?
  campaign             String?
  assignedToId         String?
  createdById          String
  notes                String?
  lastContactDate      DateTime?
  followUpDate         DateTime?
  estimatedValue       Decimal?
  leadScore            Int?
  referredBy           String?
  isActive             Boolean          @default(true)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  name                 String
  originatingInquiryId String?          @unique
  activityLog          ActivityLog[]
  client               Client?
  contactHistory       ContactHistory[]
  inquiries            Inquiry[]        @relation("LeadInquiries")
  assignedTo           User?            @relation("assignedLeads", fields: [assignedToId], references: [id])
  company              Company?         @relation(fields: [companyId], references: [id])
  createdBy            User             @relation("createdLeads", fields: [createdById], references: [id])
  originatingInquiry   Inquiry?         @relation("OriginatingInquiry", fields: [originatingInquiryId], references: [id])
  quotations           Quotation[]

  @@index([email])
  @@index([phone])
  @@index([companyId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([isActive])
}

model Client {
  id                        String           @id @default(uuid())
  companyId                 String?
  clientName                String
  accountNumber             String?          @unique
  primaryEmail              String?
  primaryPhone              String?
  billingAddressStreet      String?
  billingAddressCity        String?
  billingAddressRegion      String?
  billingAddressPostalCode  String?
  billingAddressCountry     String?
  shippingAddressStreet     String?
  shippingAddressCity       String?
  shippingAddressRegion     String?
  shippingAddressPostalCode String?
  shippingAddressCountry    String?
  status                    ClientStatus     @default(Active)
  notes                     String?
  convertedFromLeadId       String?          @unique
  isActive                  Boolean          @default(true)
  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt
  activityLog               ActivityLog[]
  company                   Company?         @relation(fields: [companyId], references: [id])
  convertedFromLead         Lead?            @relation(fields: [convertedFromLeadId], references: [id])
  contactHistory            ContactHistory[]
  inquiries                 Inquiry[]        @relation("ClientInquiries")
  invoices                  Invoice[]
  quotations                Quotation[]
  salesOrders               SalesOrder[]

  @@index([clientName])
  @@index([companyId])
  @@index([status])
  @@index([isActive])
  @@index([primaryEmail])
  @@index([primaryPhone])
}

model ActivityLog {
  id          String   @id @default(uuid())
  leadId      String?
  userId      String
  action      String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  clientId    String?
  inquiryId   String?
  client      Client?  @relation(fields: [clientId], references: [id])
  inquiry     Inquiry? @relation(fields: [inquiryId], references: [id])
  lead        Lead?    @relation(fields: [leadId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([clientId])
  @@index([userId])
  @@index([createdAt])
}

model ContactHistory {
  id        String   @id @default(uuid())
  leadId    String?
  userId    String
  method    String
  summary   String
  outcome   String?
  timestamp DateTime @default(now())
  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id])
  lead      Lead?    @relation(fields: [leadId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([clientId])
  @@index([userId])
  @@index([timestamp])
}

model Invoice {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  @@index([clientId])
}

model SalesOrder {
  id       String @id @default(uuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  quoteReferenceId String?    @unique
  quoteReference   Quotation? @relation(fields: [quoteReferenceId], references: [id])

  status SalesOrderStatus @default(Pending)

  items SalesOrderItem[]

  deliveryDate  DateTime
  deliveryAddress String?

  paymentTerms String
  notes   String? 

  createdAt  DateTime  @default(now())
  totalAmount Decimal @default(0)

  @@index([clientId])
}

model SalesOrderItem {
  id String @id @default(uuid())

  salesOrderId String
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity   Int
  unitPrice  Decimal
  totalPrice Decimal
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedBy   String
  updatedAt   DateTime @updatedAt
}

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
}

model StockMovement {
  id String @id @default(uuid())

  productId String
  product   Product @relation(fields: [productId], references: [id])

  type     MovementType
  quantity Decimal

  reason      String?
  referenceId String?

  createdById String

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])
}

model Product {
  id             String      @id @default(uuid())
  category       Category
  sku            String      @unique
  name           String
  description    String
  basePrice      Decimal
  pricingUnit    PricingUnit
  pricingDetails Json?
  unit           String?
  pickUpPrice    Decimal?
  deliveryPrice  Decimal?

  quantityOnHand  Decimal          @default(0)
  reorderLevel    Decimal          @default(10)
  stockMovements  StockMovement[]
  salesOrderItems SalesOrderItem[]

  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  aggregate      Aggregate?
  heavyEquipment HeavyEquipment?
  inquiries      InquiryItem[]
  quotation      QuotationItem[]
  steel          Steel?
}

model Aggregate {
  id            String  @id @default(uuid())
  source        String
  weightPerUnit Float?
  productId     String  @unique
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model HeavyEquipment {
  id            String  @id @default(uuid())
  equipmentType String?
  productId     String  @unique
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Steel {
  id                   String  @id @default(uuid())
  grade                String?
  length               String?
  type                 String?
  color                String?
  size                 String?
  additionalAttributes Json?
  productId            String  @unique
  product              Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Inquiry {
  id               String          @id @default(uuid())
  phoneNumber      String
  email            String
  isCompany        Boolean         @default(false)
  companyName      String?
  companyAddress   String?
  inquiryType      InquiryType
  deliveryMethod   DeliveryMethod
  deliveryLocation String?
  preferredDate    DateTime?
  referenceSource  ReferenceSource
  remarks          String?
  status           InquiryStatus   @default(New)
  priority         Priority?
  dueDate          DateTime?
  createdById      String
  assignedToId     String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  clientName       String
  leadId           String?
  clientId         String?
  activityLog      ActivityLog[]
  assignedTo       User?           @relation("assignedInquiries", fields: [assignedToId], references: [id])
  client           Client?         @relation("ClientInquiries", fields: [clientId], references: [id])
  createdBy        User            @relation(fields: [createdById], references: [id])
  lead             Lead?           @relation("LeadInquiries", fields: [leadId], references: [id])
  items            InquiryItem[]
  leadOriginated   Lead?           @relation("OriginatingInquiry")

  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
  @@index([createdAt])
  @@index([dueDate])
  @@index([priority])
  @@index([clientName])
  @@index([phoneNumber])
  @@index([email])
  @@index([inquiryType])
}

model InquiryItem {
  id        String   @id @default(uuid())
  inquiryId String
  productId String
  quantity  Int
  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  inquiry   Inquiry  @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@index([inquiryId])
  @@index([productId])
}

model Quotation {
  id              String          @id @default(uuid())
  quotationNumber String          @unique
  status          QuotationStatus @default(Draft)
  issueDate       DateTime        @default(now())
  validUntil      DateTime
  leadId          String?
  clientId        String?
  subtotal        Decimal         @db.Decimal(10, 2)
  discount        Decimal?        @db.Decimal(10, 2)
  tax             Decimal?        @db.Decimal(10, 2)
  total           Decimal         @db.Decimal(10, 2)
  notesToCustomer String?
  internalNotes   String?
  preparedById    String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  pdfUrl          String?
  client          Client?         @relation(fields: [clientId], references: [id])
  lead            Lead?           @relation(fields: [leadId], references: [id])
  preparedBy      User            @relation(fields: [preparedById], references: [id])
  items           QuotationItem[]
  salesOrder      SalesOrder?

  @@index([status])
  @@index([issueDate])
  @@index([validUntil])
  @@index([leadId])
  @@index([clientId])
  @@index([preparedById])
  @@index([quotationNumber])
}

model QuotationItem {
  id          String    @id @default(uuid())
  quotationId String
  productId   String
  description String
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  lineTotal   Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  product     Product   @relation(fields: [productId], references: [id])
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@index([quotationId])
  @@index([productId])
}

model DocumentCategory {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  documents   Document[]
}

model Document {
  id           Int              @id @default(autoincrement())
  title        String
  filename     String
  fileType     String
  fileSize     Int
  filePath     String
  uploadedById String
  categoryId   Int
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  category     DocumentCategory @relation(fields: [categoryId], references: [id])
  uploadedBy   User             @relation(fields: [uploadedById], references: [id])
}

model Attendance {
  id         String     @id @default(uuid())
  userId     String
  date       DateTime   @default(now())
  timeIn     DateTime   @default(now())
  timeOut    DateTime?
  status     String
  totalHours Float?
  ipAddress  String?
  device     String?
  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  user       User       @relation(fields: [userId], references: [id])
  breakLogs  BreakLog[]

  @@index([userId])
  @@index([date])
  @@index([status])
}

model AllowedIP {
  id          String   @id @default(uuid())
  userId      String
  ipAddress   String
  description String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, ipAddress])
}

model BreakLog {
  id           String     @id @default(uuid())
  attendanceId String
  startTime    DateTime   @default(now())
  endTime      DateTime?
  duration     Float?
  reason       String?
  attendance   Attendance @relation(fields: [attendanceId], references: [id])

  @@index([attendanceId])
}

model DTRSettings {
  id                  String   @id @default(cuid())
  workStartTime       String   @default("08:00")
  lateThreshold       Int      @default(15)
  allowRemoteLogin    Boolean  @default(false)
  autoRemindersActive Boolean  @default(true)
  updatedById         String
  updatedAt           DateTime @updatedAt
}

model Sequence {
  name    String @id
  current Int    @default(0)
}

enum LeadStatus {
  New
  Contacted
  Qualified
  ProposalSent
  Negotiation
  Won
  Lost
  Archived
}

enum ClientStatus {
  Active
  Inactive
  OnHold
}

enum Category {
  AGGREGATE
  HEAVY_EQUIPMENT
  STEEL
}

enum PricingUnit {
  DAY
  METER
  KILOGRAM
  TON
}

enum DeliveryMethod {
  Delivery
  Pickup
  ThirdParty
}

enum ReferenceSource {
  Facebook
  Instagram
  TikTok
  Referral
  Flyers
  Other
}

enum Priority {
  Low
  Medium
  High
  Urgent
}

enum InquiryType {
  PricingRequest
  ProductAvailability
  TechnicalQuestion
  DeliveryInquiry
  Other
}

enum InquiryStatus {
  New
  Reviewed
  ConvertedToLead
  AssociatedToClient
  Closed
  QuotationGenerated
  DeliveryScheduled
}

enum QuotationStatus {
  Draft
  Sent
  Accepted
  Rejected
  Expired
  Converted
}

enum AttendanceStatus {
  PRESENT
  LATE
  ON_BREAK
  LOGGED_OUT
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
}

enum SalesOrderStatus {
  Pending
  Processing
  ReadyForPickup
  OutForDelivery
  Completed
  Cancelled
}
